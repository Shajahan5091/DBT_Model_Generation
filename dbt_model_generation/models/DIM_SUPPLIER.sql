{#
------------------------------------------------------------------------
MODEL NAME: dim_supplier
TARGET TABLE: bsl_ma.dwh_ma.dim_supplier
SOURCE TABLES: bsl_raw.dwh_raw.suppliers
DESCRIPTION: Supplier master dimension table that transforms raw supplier data into a clean dimensional model with surrogate keys and standardized formatting
PREREQUISITES: Source table bsl_raw.dwh_raw.suppliers must exist and contain supplier data
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(
    materialized='table'
) }}

with source_data as (
    select * from {{ source('dwh_raw', 'suppliers') }}
),

transformed as (
    select
        -- Generate surrogate key from supplier_id
        {{ dbt_utils.generate_surrogate_key(['supplier_id']) }} as supplier_sk,
        
        -- Direct mapping of supplier_id
        supplier_id,
        
        -- Trim and title-case supplier name
        initcap(trim(supplier_name)) as supplier_name,
        
        -- Lowercase email and validate pattern
        case 
            when contact_email is not null 
                and regexp_like(contact_email, '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$')
            then lower(trim(contact_email))
            else null
        end as contact_email,
        
        -- Uppercase country
        upper(trim(country)) as country,
        
        -- Direct mapping with null default to false
        coalesce(active_flag, false) as is_active,
        
        -- Audit fields
        current_timestamp() as dbt_created_at,
        current_timestamp() as dbt_updated_at
        
    from source_data
)

select * from transformed