{#
------------------------------------------------------------------------
MODEL NAME: DimCustomer
TARGET TABLE: BSL_FINAL.DWH_MA.DIMCUSTOMER
SOURCE TABLES: BSL_STAGING.DWH_STAGING.CUSTOMER, BSL_STAGING.DWH_STAGING.CUSTOMER_ADDRESS, BSL_STAGING.DWH_STAGING.ADDRESS
DESCRIPTION: Stores customer profile attributes with historical tracking when customer details change. This model creates a dimensional table for customers by combining customer information with their address details.
PREREQUISITES: Source tables customer, customer_address, and address must be available in staging layer
PARAMETER: None
AUTHOUR: AI Generated by Shajahan - 2024-12-19
------------------------------------------------------------------------
#}

{{ config(materialized='view') }}

WITH customer_base AS (
    SELECT 
        customer_id,
        first_name,
        last_name,
        email,
        phone,
        created_ts
    FROM {{ source('dwh_staging', 'customer') }}
),

customer_address_mapping AS (
    SELECT 
        customer_id,
        address_id
    FROM {{ source('dwh_staging', 'customer_address') }}
),

address_details AS (
    SELECT 
        address_id,
        city,
        state,
        country
    FROM {{ source('dwh_staging', 'address') }}
),

customer_with_address AS (
    SELECT 
        cb.customer_id,
        cb.first_name,
        cb.last_name,
        cb.email,
        cb.phone,
        cb.created_ts,
        ad.city,
        ad.state,
        ad.country
    FROM customer_base cb
    LEFT JOIN customer_address_mapping cam 
        ON cb.customer_id = cam.customer_id
    LEFT JOIN address_details ad 
        ON cam.address_id = ad.address_id
),

final AS (
    SELECT 
        customer_id::INTEGER AS customer_id,
        CONCAT(COALESCE(first_name, ''), ' ', COALESCE(last_name, ''))::VARCHAR(150) AS full_name,
        email::VARCHAR(100) AS email,
        phone::VARCHAR(20) AS phone,
        city::VARCHAR(100) AS city,
        state::VARCHAR(50) AS state,
        country::VARCHAR(50) AS country,
        CASE 
            WHEN created_ts >= DATEADD(YEAR, -2, CURRENT_DATE()) 
            THEN TRUE 
            ELSE FALSE 
        END::BOOLEAN AS is_current
    FROM customer_with_address
)

SELECT * FROM final