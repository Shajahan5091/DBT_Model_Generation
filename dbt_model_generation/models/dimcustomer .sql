{#
------------------------------------------------------------------------
MODEL NAME: DimCustomer
TARGET TABLE: BSL_FINAL.DWH_MA.DIMCUSTOMER
SOURCE TABLES: BSL_STAGING.DWH_STAGING.CUSTOMER, BSL_STAGING.DWH_STAGING.CUSTOMER_ADDRESS, BSL_STAGING.DWH_STAGING.ADDRESS
DESCRIPTION: Stores customer profile attributes with historical tracking when customer details change. This dimension table consolidates customer information including personal details and address information through lookup operations.
PREREQUISITES: Source tables customer, customer_address, and address must be available in staging area
PARAMETER: None
AUTHOR: AI Generated by Shajahan - 2024-12-19
------------------------------------------------------------------------
#}

{{ config(materialized='view') }}

with customer_base as (
    select
        customer_id,
        first_name,
        last_name,
        email,
        phone,
        created_ts
    from {{ source('dwh_staging', 'customer') }}
),

customer_address_lookup as (
    select
        customer_id,
        address_id
    from {{ source('dwh_staging', 'customer_address') }}
),

address_details as (
    select
        address_id,
        city,
        state,
        country
    from {{ source('dwh_staging', 'address') }}
),

customer_with_address as (
    select
        cb.customer_id,
        cb.first_name,
        cb.last_name,
        cb.email,
        cb.phone,
        cb.created_ts,
        ad.city,
        ad.state,
        ad.country
    from customer_base cb
    left join customer_address_lookup cal
        on cb.customer_id = cal.customer_id
    left join address_details ad
        on cal.address_id = ad.address_id
),

final as (
    select
        customer_id,
        concat(first_name, ' ', last_name) as full_name,
        email, -- Verify whether the email is valid
        phone,
        city,
        state,
        country,
        case 
            when created_ts >= dateadd(year, -2, current_date()) then true
            else false
        end as is_current
    from customer_with_address
)

select * from final