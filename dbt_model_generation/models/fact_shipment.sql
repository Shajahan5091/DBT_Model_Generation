{#
------------------------------------------------------------------------
MODEL NAME: fact_shipment
TARGET TABLE: bsl_ma.dwh_ma.fact_shipment
SOURCE TABLES: bsl_raw.dwh_raw.shipments, bsl_raw.dwh_raw.orders
DESCRIPTION: This model transforms raw shipment data by joining with order information to calculate shipping metrics and standardize carrier information. It includes business logic for calculating days to ship and handles data quality issues.
PREREQUISITES: Source tables shipments and orders must exist with valid data relationships
PARAMETER: Incremental model with shipment_date based filtering
AUTHOUR: AI Generated by Shajahan - Created: 2024-12-19 IST
------------------------------------------------------------------------
#}

{{ config(
    materialized = 'incremental',
    unique_key = 'shipment_id'
) }}

WITH source_shipments AS (
    SELECT
        shipment_id,
        order_id,
        shipped_date,
        carrier,
        tracking_number
    FROM {{ source('dwh_raw', 'shipments') }}
    {% if is_incremental() %}
        WHERE shipped_date::date > (select coalesce(max(shipped_date), '1900-01-01') from {{ this }})
    {% endif %}
),

source_orders AS (
    SELECT
        order_id,
        order_date
    FROM {{ source('dwh_raw', 'orders') }}
),

joined_data AS (
    SELECT
        s.shipment_id,
        s.order_id,
        s.shipped_date::date as shipped_date,
        UPPER(s.carrier) as carrier,
        s.tracking_number,
        o.order_date
    FROM source_shipments s
    LEFT JOIN source_orders o
        ON s.order_id = o.order_id
    WHERE o.order_id IS NOT NULL  -- Skip if order missing
),

transformed AS (
    SELECT
        shipment_id,
        order_id,
        shipped_date,
        carrier,
        tracking_number,
        GREATEST(0, DATEDIFF('day', order_date::date, shipped_date)) as days_to_ship
    FROM joined_data
)

SELECT * FROM transformed