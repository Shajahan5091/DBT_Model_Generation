{#
------------------------------------------------------------------------
MODEL NAME: FactReturns
TARGET TABLE: BSL_FINAL.DWH_MA.FACTRETURNS
SOURCE TABLES: BSL_STAGING.DWH_STAGING.RETURNS, BSL_STAGING.DWH_STAGING.ORDER_LINE
DESCRIPTION: Captures product return events with return date, return reason, and associated order line. This model combines return data with order line information to provide comprehensive return analytics.
PREREQUISITES: Source tables Returns and Order_Line must be available in staging layer
PARAMETER: Incremental model based on return_date
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(
    materialized='incremental',
    unique_key='order_line_id'
) }}

with returns_data as (
    select
        return_date,
        order_line_id,
        return_reason
    from {{ source('dwh_staging', 'returns') }}
    {% if is_incremental() %}
        where return_date > (select max(return_date) from {{ this }})
    {% endif %}
),

order_line_data as (
    select
        order_line_id,
        product_id
    from {{ source('dwh_staging', 'order_line') }}
),

final as (
    select
        r.return_date,
        r.order_line_id,
        ol.product_id,
        r.return_reason
    from returns_data r
    left join order_line_data ol
        on r.order_line_id = ol.order_line_id
)

select * from final