{#
------------------------------------------------------------------------
MODEL NAME: dim_product
TARGET TABLE: bsl_ma.dwh_ma.dim_product
SOURCE TABLES: bsl_raw.dwh_raw.products
DESCRIPTION: Product dimension table that transforms raw product data with category lookups, price banding, and data quality validations
PREREQUISITES: dim_category table must exist for category lookups
PARAMETER: None
AUTHOUR: AI Generated by Shajahan - 2024-12-19 IST
------------------------------------------------------------------------
#}

{{ config(
    materialized='table'
) }}

with source_data as (
    select 
        product_id,
        product_name,
        category_id,
        price
    from {{ source('dwh_raw', 'products') }}
),

category_lookup as (
    select 
        category_id as cat_id
    from {{ ref('dim_category') }}
),

transformed as (
    select 
        -- Direct mapping with unique constraint
        s.product_id,
        
        -- Title-case product name with trimmed spaces
        initcap(trim(regexp_replace(s.product_name, '\\s+', ' '))) as product_name,
        
        -- Category lookup with fallback to 0 if missing
        coalesce(c.cat_id, 0)::integer as category_id,
        
        -- Direct price mapping with precision
        s.price::number(10,2) as price,
        
        -- Price banding logic
        case 
            when s.price < 50 then 'Low'
            when s.price >= 50 and s.price <= 199.99 then 'Mid'
            when s.price >= 200 and s.price <= 499.99 then 'High'
            when s.price >= 500 then 'Premium'
            else 'Unknown'
        end as price_band,
        
        -- Flag for review when price is 0
        case 
            when s.price = 0 then 'Price is zero - requires review'
            else null
        end as review_notes
        
    from source_data s
    left join category_lookup c 
        on s.category_id = c.cat_id
)

select * from transformed