{#
------------------------------------------------------------------------
MODEL NAME: DIM_PRODUCT
TARGET TABLE: BSL_MA.DWH_MA.DIM_PRODUCT
SOURCE TABLES: BSL_RAW.DWH_RAW.PRODUCT, BSL_MA.DWH_MA.DIM_CATEGORY
DESCRIPTION: Product master dimension table that transforms raw product data with surrogate key generation, category lookups, and price banding
PREREQUISITES: DIM_CATEGORY table must exist and be populated
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(
    materialized='table'
) }}

with source_data as (
    select 
        PRODUCT_ID,
        PRODUCT_NAME,
        CATEGORY_ID,
        PRICE
    from {{ source('dwh_raw', 'PRODUCT') }}
    -- Filter out rows with negative or null prices as per business rules
    where PRICE is not null and PRICE >= 0
),

category_lookup as (
    select 
        CATEGORY_ID,
        CATEGORY_SK
    from {{ ref('DIM_CATEGORY') }}
),

transformed_data as (
    select
        -- Generate surrogate key from PRODUCT_ID
        {{ dbt_utils.generate_surrogate_key(['s.PRODUCT_ID']) }} as PRODUCT_SK,
        
        -- Direct mapping of PRODUCT_ID
        s.PRODUCT_ID,
        
        -- Title-case product name and trim excessive spaces
        initcap(trim(regexp_replace(s.PRODUCT_NAME, '\\s+', ' '))) as PRODUCT_NAME,
        
        -- Lookup CATEGORY_SK, set to 0 if missing in DIM_CATEGORY
        coalesce(c.CATEGORY_SK, 0) as CATEGORY_SK,
        
        -- Direct mapping of PRICE
        cast(s.PRICE as number(10,2)) as PRICE,
        
        -- Price banding logic
        case 
            when s.PRICE < 50 then 'Low'
            when s.PRICE >= 50 and s.PRICE <= 199.99 then 'Mid'
            when s.PRICE >= 200 and s.PRICE <= 499.99 then 'High'
            when s.PRICE >= 500 then 'Premium'
            else 'Unknown'
        end as PRICE_BAND,
        
        -- Add notes for zero price items
        case 
            when s.PRICE = 0 then 'Price is zero - flagged for review'
            else null
        end as NOTES,
        
        current_timestamp() as CREATED_TIMESTAMP,
        current_timestamp() as UPDATED_TIMESTAMP
        
    from source_data s
    left join category_lookup c
        on s.CATEGORY_ID = c.CATEGORY_ID
)

select * from transformed_data