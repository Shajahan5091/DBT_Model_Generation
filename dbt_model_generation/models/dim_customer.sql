{#
------------------------------------------------------------------------
MODEL NAME: dim_customer
TARGET TABLE: BSL_MA.DWH_MA.DIM_CUSTOMER
SOURCE TABLES: BSL_RAW.DWH_RAW.CUSTOMERS, BSL_RAW.DWH_RAW.ORDERS
DESCRIPTION: Customer dimension table that transforms raw customer data with proper formatting, email validation, and derives customer tier based on spending patterns in the last 365 days
PREREQUISITES: Source tables customers and orders must be available in dwh_raw
PARAMETER: None
AUTHOR: AI Generated by Shajahan - 2024-12-19 (IST)
------------------------------------------------------------------------
#}

WITH source_customers AS (
    SELECT 
        customer_id,
        first_name,
        last_name,
        email,
        inserted_at
    FROM {{ source('dwh_raw', 'customers') }}
),

source_orders AS (
    SELECT 
        customer_id,
        order_id,
        total_amount,
        order_date
    FROM {{ source('dwh_raw', 'orders') }}
),

-- Calculate customer spending in last 365 days
customer_spending AS (
    SELECT 
        customer_id,
        SUM(total_amount) AS total_spending_365_days
    FROM source_orders
    WHERE order_date >= DATEADD(day, -365, CURRENT_DATE())
    GROUP BY customer_id
),

-- Transform customer data
transformed_customers AS (
    SELECT 
        c.customer_id,
        UPPER(TRIM(c.first_name)) AS first_name,
        UPPER(TRIM(c.last_name)) AS last_name,
        CASE 
            WHEN REGEXP_LIKE(LOWER(TRIM(c.email)), '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$')
            THEN LOWER(TRIM(c.email))
            ELSE NULL
        END AS email,
        COALESCE(DATE(c.inserted_at), CURRENT_DATE()) AS customer_since_date,
        COALESCE(cs.total_spending_365_days, 0) AS total_spending_365_days
    FROM source_customers c
    LEFT JOIN customer_spending cs ON c.customer_id = cs.customer_id
),

-- Final transformation with customer tier
final AS (
    SELECT 
        customer_id,
        first_name,
        last_name,
        email,
        customer_since_date,
        CASE 
            WHEN total_spending_365_days >= 1000 THEN 'Gold'
            WHEN total_spending_365_days >= 500 THEN 'Silver'
            ELSE 'Bronze'
        END AS customer_tier
    FROM transformed_customers
)

SELECT * FROM final