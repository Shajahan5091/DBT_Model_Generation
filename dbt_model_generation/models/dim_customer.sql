{#
------------------------------------------------------------------------
MODEL NAME    : dim_customer
TARGET TABLE  : bsl_ma.dwh_ma.dim_customer
SOURCE TABLES : bsl_raw.dwh_raw.customers, bsl_raw.dwh_raw.orders
DESCRIPTION   : Customer dimension table with derived customer tier based on spending patterns
PREREQUISITES : Source tables customers and orders must be available
PARAMETER     : None
AUTHOR        : AI Generated by Shajahan - 2024-12-19 IST
------------------------------------------------------------------------
#}

{{ config(
    materialized = 'view'
) }}

WITH customers_source AS (
    SELECT
        c.customer_id,
        c.first_name,
        c.last_name,
        c.email,
        c.inserted_at
    FROM {{ source('dwh_raw', 'customers') }} c
),

orders_source AS (
    SELECT
        o.customer_id,
        o.total_amount,
        o.order_date
    FROM {{ source('dwh_raw', 'orders') }} o
    WHERE o.order_date >= DATEADD(day, -365, CURRENT_DATE())
),

customer_spending AS (
    SELECT
        c.customer_id,
        COALESCE(SUM(o.total_amount), 0) AS total_spending_365_days
    FROM customers_source c
    LEFT JOIN orders_source o ON c.customer_id = o.customer_id
    GROUP BY c.customer_id
),

transformed AS (
    SELECT
        c.customer_id,
        TRIM(UPPER(c.first_name)) AS first_name,
        TRIM(UPPER(c.last_name)) AS last_name,
        CASE 
            WHEN c.email IS NOT NULL AND c.email LIKE '%@%' 
            THEN LOWER(c.email)
            ELSE NULL
        END AS email,
        COALESCE(DATE(c.inserted_at), CURRENT_DATE()) AS customer_since_date,
        CASE 
            WHEN cs.total_spending_365_days >= 1000 THEN 'Gold'
            WHEN cs.total_spending_365_days >= 500 THEN 'Silver'
            ELSE 'Bronze'
        END AS customer_tier
    FROM customers_source c
    LEFT JOIN customer_spending cs ON c.customer_id = cs.customer_id
)

SELECT * FROM transformed