{#
------------------------------------------------------------------------
MODEL NAME: dim_customer
TARGET TABLE: bsl_ma.dwh_ma.dim_customer
SOURCE TABLES: bsl_raw.dwh_raw.customers, bsl_raw.dwh_raw.orders
DESCRIPTION: Customer dimension table that transforms raw customer data with cleansed names, validated emails, and derived customer tiers based on spending patterns
PREREQUISITES: Source tables customers and orders must be available in dwh_raw schema
PARAMETER: None
AUTHOR: AI Generated by Shajahan - 2024-12-19 IST
------------------------------------------------------------------------
#}

with source_customers as (
    select 
        customer_id,
        first_name,
        last_name,
        email,
        inserted_at
    from {{ source('dwh_raw', 'customers') }}
),

source_orders as (
    select 
        customer_id,
        order_id,
        total_amount,
        order_date
    from {{ source('dwh_raw', 'orders') }}
),

customer_spending as (
    select 
        customer_id,
        sum(total_amount) as total_spending_365_days
    from source_orders
    where order_date >= dateadd('day', -365, current_date())
    group by customer_id
),

transformed_customers as (
    select 
        sc.customer_id,
        
        -- Transform first_name: trim and uppercase
        upper(trim(sc.first_name)) as first_name,
        
        -- Transform last_name: trim and uppercase  
        upper(trim(sc.last_name)) as last_name,
        
        -- Transform email: lowercase and validate pattern
        case 
            when sc.email is null then null
            when sc.email rlike '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$' 
                then lower(trim(sc.email))
            else null
        end as email,
        
        -- Convert timestamp to date, default to current_date if null
        coalesce(sc.inserted_at::date, current_date()) as customer_since_date,
        
        -- Derive customer tier based on spending in last 365 days
        case 
            when coalesce(cs.total_spending_365_days, 0) >= 1000 then 'Gold'
            when coalesce(cs.total_spending_365_days, 0) >= 500 then 'Silver'
            else 'Bronze'
        end as customer_tier
        
    from source_customers sc
    left join customer_spending cs 
        on sc.customer_id = cs.customer_id
)

select * from transformed_customers