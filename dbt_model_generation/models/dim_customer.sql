{#
------------------------------------------------------------------------
MODEL NAME    : dim_customer
TARGET TABLE  : bsl_ma.dwh_ma.dim_customer
SOURCE TABLES : bsl_raw.dwh_raw.customers, bsl_raw.dwh_raw.orders
DESCRIPTION   : Customer dimension table with customer details and derived 
                spending tier based on order history
PREREQUISITES : Source tables customers and orders must be available
PARAMETER     : None
AUTHOR        : AI Generated by Shajahan - 2025-01-27 (IST)
------------------------------------------------------------------------
#}

{{ config(
    materialized = 'view',
    alias = 'dim_customer'
) }}

WITH customers_source AS (
    SELECT
        customer_id,
        first_name,
        last_name,
        email,
        inserted_at
    FROM {{ source('dwh_raw', 'customers') }}
),

orders_source AS (
    SELECT
        order_id,
        customer_id,
        total_amount,
        order_date
    FROM {{ source('dwh_raw', 'orders') }}
),

customer_spending AS (
    SELECT
        orders_source.customer_id,
        SUM(orders_source.total_amount) AS total_spending_365_days
    FROM orders_source
    WHERE orders_source.order_date >= DATEADD(day, -365, CURRENT_DATE())
    GROUP BY orders_source.customer_id
),

transformed AS (
    SELECT
        customers_source.customer_id,
        UPPER(TRIM(customers_source.first_name)) AS first_name,
        UPPER(TRIM(customers_source.last_name)) AS last_name,
        CASE 
            WHEN REGEXP_LIKE(LOWER(TRIM(customers_source.email)), '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$')
            THEN LOWER(TRIM(customers_source.email))
            ELSE NULL
        END AS email,
        CASE 
            WHEN customers_source.inserted_at IS NULL 
            THEN CURRENT_DATE()
            ELSE DATE(customers_source.inserted_at)
        END AS customer_since_date,
        CASE 
            WHEN customer_spending.total_spending_365_days >= 1000 THEN 'Gold'
            WHEN customer_spending.total_spending_365_days >= 500 THEN 'Silver'
            ELSE 'Bronze'
        END AS customer_tier
    FROM customers_source
    LEFT JOIN customer_spending 
        ON customers_source.customer_id = customer_spending.customer_id
)

SELECT * FROM transformed