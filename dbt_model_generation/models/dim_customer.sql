{#
------------------------------------------------------------------------
MODEL NAME: dim_customer
TARGET TABLE: bsl_ma.dwh_ma.dim_customer
SOURCE TABLES: bsl_raw.dwh_raw.customers, bsl_raw.dwh_raw.orders
DESCRIPTION: Customer dimension table that consolidates customer information with derived customer tier based on spending patterns in the last 365 days
PREREQUISITES: Source tables customers and orders must be available in dwh_raw schema
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

with customers_base as (
    select
        customer_id,
        trim(upper(first_name)) as first_name,
        trim(upper(last_name)) as last_name,
        case 
            when email ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' 
            then lower(trim(email))
            else null
        end as email,
        coalesce(inserted_at::date, current_date()) as customer_since_date
    from {{ source('dwh_raw', 'customers') }}
),

customer_spending as (
    select
        o.customer_id,
        sum(o.total_amount) as total_spending_365_days
    from {{ source('dwh_raw', 'orders') }} o
    where o.order_date >= dateadd('day', -365, current_date())
    group by o.customer_id
),

customer_tier_calculation as (
    select
        c.customer_id,
        c.first_name,
        c.last_name,
        c.email,
        c.customer_since_date,
        case
            when coalesce(cs.total_spending_365_days, 0) >= 1000 then 'Gold'
            when coalesce(cs.total_spending_365_days, 0) >= 500 then 'Silver'
            else 'Bronze'
        end as customer_tier
    from customers_base c
    left join customer_spending cs
        on c.customer_id = cs.customer_id
)

select
    customer_id,
    first_name,
    last_name,
    email,
    customer_since_date,
    customer_tier
from customer_tier_calculation