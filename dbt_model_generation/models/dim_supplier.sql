{#
------------------------------------------------------------------------
MODEL NAME: dim_supplier
TARGET TABLE: BSL_MA.DWH_MA.DIM_SUPPLIER
SOURCE TABLES: BSL_RAW.DWH_RAW.SUPPLIERS
DESCRIPTION: Dimension table for suppliers with cleaned and standardized data including supplier details, contact information, and status flags
PREREQUISITES: Source table BSL_RAW.DWH_RAW.SUPPLIERS must be available
PARAMETER: None
AUTHOUR: AI Generated by Shajahan - 2024-12-19
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

with source_data as (
    select
        supplier_id,
        supplier_name,
        contact_email,
        country,
        active_flag
    from {{ source('dwh_raw', 'suppliers') }}
),

transformed_data as (
    select
        -- Direct mapping for supplier_id
        supplier_id,
        
        -- Trim and title-case for supplier_name
        initcap(trim(supplier_name)) as supplier_name,
        
        -- Lowercase email with validation - set null if invalid pattern
        case 
            when contact_email rlike '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$' 
            then lower(trim(contact_email))
            else null
        end as contact_email,
        
        -- Uppercase country
        upper(trim(country)) as country,
        
        -- Direct mapping for active_flag with default false for null values
        coalesce(active_flag, false) as is_active
        
    from source_data
)

select * from transformed_data