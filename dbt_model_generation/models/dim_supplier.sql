{#
------------------------------------------------------------------------
MODEL NAME    : dim_supplier
TARGET TABLE  : bsl_ma.dwh_ma.dim_supplier
SOURCE TABLES : bsl_raw.dwh_raw.suppliers
DESCRIPTION   : Dimension table for supplier information with data quality
                transformations including email validation, name formatting,
                and country standardization
PREREQUISITES : Source table bsl_raw.dwh_raw.suppliers must exist
PARAMETER     : None
AUTHOUR       : AI Generated by Shajahan
                Created Date: 12-Dec-2024 (IST)
------------------------------------------------------------------------
#}

{{ config(
    materialized = 'table'
) }}

WITH source_data AS (
    SELECT
        s.supplier_id,
        s.supplier_name,
        s.contact_email,
        s.country,
        s.active_flag
    FROM {{ source('dwh_raw', 'suppliers') }} s
),

transformed AS (
    SELECT
        s.supplier_id,
        INITCAP(TRIM(s.supplier_name)) AS supplier_name,
        CASE 
            WHEN REGEXP_LIKE(LOWER(s.contact_email), '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$')
            THEN LOWER(s.contact_email)
            ELSE NULL
        END AS contact_email,
        UPPER(s.country) AS country,
        COALESCE(s.active_flag, FALSE) AS is_active
    FROM source_data s
)

SELECT * FROM transformed