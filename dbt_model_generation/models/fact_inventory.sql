{#
------------------------------------------------------------------------
MODEL NAME: fact_inventory
TARGET TABLE: BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES: BSL_RAW.DWH_RAW.INVENTORY
DESCRIPTION: Inventory latest snapshot model that transforms raw inventory data with product and supplier lookups, data quality checks, and latest record flagging
PREREQUISITES: dim_product and dim_supplier models must exist
PARAMETER: None
AUTHOR: AI Generated by Shajahan - 2024-12-19 IST
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

with source_data as (
    select 
        product_id,
        supplier_id,
        stock_qty,
        warehouse_location,
        last_updated
    from {{ source('dwh_raw', 'inventory') }}
),

-- Add window function to identify latest records per composite key
latest_records as (
    select 
        *,
        row_number() over (
            partition by product_id, supplier_id 
            order by last_updated desc
        ) = 1 as is_latest
    from source_data
),

-- Apply transformations and data quality rules
transformed_data as (
    select 
        -- Product ID lookup with unknown handling
        coalesce(
            case 
                when dp.product_id is not null then src.product_id
                else '0'
            end, 
            '0'
        ) as product_id,
        
        -- Supplier ID lookup with unknown handling  
        coalesce(
            case 
                when ds.supplier_id is not null then src.supplier_id
                else '0'
            end,
            '0'
        ) as supplier_id,
        
        -- Stock quantity with negative value handling
        case 
            when src.stock_qty < 0 then null
            else src.stock_qty
        end as stock_qty,
        
        -- Uppercase warehouse location
        upper(src.warehouse_location) as warehouse_location,
        
        -- Convert timestamp to date
        src.last_updated::date as snapshot_date,
        
        -- Latest record flag
        src.is_latest
        
    from latest_records src
    left join {{ ref('dim_product') }} dp 
        on src.product_id = dp.product_id
    left join {{ ref('dim_supplier') }} ds 
        on src.supplier_id = ds.supplier_id
)

select * from transformed_data