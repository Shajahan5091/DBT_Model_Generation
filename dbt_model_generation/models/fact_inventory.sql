{#
------------------------------------------------------------------------
MODEL NAME: fact_inventory
TARGET TABLE: bsl_ma.dwh_ma.fact_inventory
SOURCE TABLES: bsl_raw.dwh_raw.inventory
DESCRIPTION: Inventory latest snapshot model that transforms raw inventory data with product and supplier lookups, handles missing values, and flags latest records per product-supplier combination
PREREQUISITES: dim_product and dim_supplier tables must exist
PARAMETER: None
AUTHOR: AI Generated by Shajahan - 2024-12-19 IST
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

with source_data as (
    select 
        product_id,
        supplier_id,
        stock_qty,
        warehouse_location,
        last_updated
    from {{ source('dwh_raw', 'inventory') }}
),

product_lookup as (
    select 
        product_id
    from {{ ref('dim_product') }}
),

supplier_lookup as (
    select 
        supplier_id  
    from {{ ref('dim_supplier') }}
),

transformed_data as (
    select 
        -- Product ID lookup with unknown handling
        coalesce(p.product_id, '0') as product_id,
        
        -- Supplier ID lookup with unknown handling  
        coalesce(s.supplier_id, '0') as supplier_id,
        
        -- Stock quantity with negative value handling
        case 
            when sd.stock_qty < 0 then null
            else sd.stock_qty
        end as stock_qty,
        
        -- Uppercase warehouse location
        upper(sd.warehouse_location) as warehouse_location,
        
        -- Convert timestamp to date
        sd.last_updated::date as snapshot_date,
        
        -- Flag latest record per product_id + supplier_id combination
        case 
            when sd.last_updated = max(sd.last_updated) over (
                partition by coalesce(p.product_id, '0'), coalesce(s.supplier_id, '0')
            ) then true
            else false
        end as is_latest
        
    from source_data sd
    left join product_lookup p on sd.product_id = p.product_id
    left join supplier_lookup s on sd.supplier_id = s.supplier_id
)

select * from transformed_data