{#
------------------------------------------------------------------------
MODEL NAME: fact_inventory
TARGET TABLE: BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES: BSL_RAW.DWH_RAW.INVENTORY
DESCRIPTION: Inventory fact table containing latest snapshot of product inventory data with supplier information, stock quantities, and warehouse locations. Includes data quality flags and audit capabilities.
PREREQUISITES: dim_product and dim_supplier dimension tables must exist
PARAMETER: None
AUTHOR: AI Generated by Shajahan - 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

with source_data as (
    select 
        product_id,
        supplier_id,
        stock_qty,
        warehouse_location,
        last_updated
    from {{ source('dwh_raw', 'inventory') }}
),

product_lookup as (
    select 
        product_id
    from {{ ref('dim_product') }}
),

supplier_lookup as (
    select 
        supplier_id  
    from {{ ref('dim_supplier') }}
),

latest_records as (
    select 
        product_id,
        supplier_id,
        max(last_updated) as max_last_updated
    from source_data
    group by product_id, supplier_id
),

transformed_data as (
    select 
        -- Product ID with unknown handling
        coalesce(pl.product_id, 
                case when sd.product_id is null then '0' 
                     else sd.product_id 
                end) as product_id,
        
        -- Supplier ID with unknown handling  
        coalesce(sl.supplier_id,
                case when sd.supplier_id is null then '0'
                     else sd.supplier_id  
                end) as supplier_id,
        
        -- Stock quantity with negative value handling
        case 
            when sd.stock_qty < 0 then null
            else sd.stock_qty
        end as stock_qty,
        
        -- Warehouse location in uppercase
        upper(sd.warehouse_location) as warehouse_location,
        
        -- Convert timestamp to date
        sd.last_updated::date as snapshot_date,
        
        -- Flag for latest record per composite key
        case 
            when sd.last_updated = lr.max_last_updated then true
            else false
        end as is_latest,
        
        sd.last_updated
        
    from source_data sd
    left join product_lookup pl 
        on sd.product_id = pl.product_id
    left join supplier_lookup sl 
        on sd.supplier_id = sl.supplier_id  
    left join latest_records lr 
        on sd.product_id = lr.product_id 
        and sd.supplier_id = lr.supplier_id
)

select 
    product_id,
    supplier_id, 
    stock_qty,
    warehouse_location,
    snapshot_date,
    is_latest
from transformed_data