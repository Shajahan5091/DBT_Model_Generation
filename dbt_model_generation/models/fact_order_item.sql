{#
------------------------------------------------------------------------
MODEL NAME: fact_order_item
TARGET TABLE: bsl_ma.dwh_ma.fact_order_item
SOURCE TABLES: bsl_raw.dwh_raw.order_items, bsl_raw.dwh_raw.orders
DESCRIPTION: This model creates a fact table for order items by transforming raw order item data with calculated fields like extended amount, discount allocation, and net amount. It includes lookups to validate order and product references.
PREREQUISITES: fact_order and dim_product models should exist for proper joins and validations
PARAMETER: Incremental materialization with condition based on existence check
AUTHOUR: AI Generated by Shajahan - 2024-12-19 IST
------------------------------------------------------------------------
#}

{{ config(
    materialized = 'incremental',
    alias = 'fact_order_item'
) }}

WITH source_order_items AS (
    SELECT
        order_item_id,
        order_id,
        product_id,
        quantity,
        unit_price
    FROM {{ source('dwh_raw', 'order_items') }}
    {% if is_incremental() %}
    WHERE exists (select 1 where true) and {{ is_incremental() }}
    {% endif %}
),

source_orders AS (
    SELECT
        order_id
    FROM {{ source('dwh_raw', 'orders') }}
),

-- Validate order_id exists in fact_order table
validated_orders AS (
    SELECT
        oi.order_item_id,
        oi.order_id,
        oi.product_id,
        oi.quantity,
        oi.unit_price
    FROM source_order_items oi
    INNER JOIN {{ ref('fact_order') }} fo ON oi.order_id = fo.order_id
),

-- Handle product_id lookup and set to 0 if missing
product_validated AS (
    SELECT
        vo.order_item_id,
        vo.order_id,
        COALESCE(dp.product_id, '0') AS product_id,
        vo.quantity,
        vo.unit_price
    FROM validated_orders vo
    LEFT JOIN {{ ref('dim_product') }} dp ON vo.product_id = dp.product_id
),

transformed AS (
    SELECT
        order_item_id,
        order_id,
        product_id,
        ROUND(quantity) AS quantity, -- Ensure integer semantics
        COALESCE(unit_price, 0) AS unit_price,
        ROUND(quantity * COALESCE(unit_price, 0), 2) AS extended_amount,
        0.00 AS discount_amount, -- Set to 0 as no discount context available
        GREATEST(0, ROUND(quantity * COALESCE(unit_price, 0), 2) - 0.00) AS net_amount -- Ensure non-negative, floor at 0
    FROM product_validated
)

SELECT * FROM transformed