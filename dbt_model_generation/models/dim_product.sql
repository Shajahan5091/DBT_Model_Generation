{#
------------------------------------------------------------------------
MODEL NAME: dim_product
TARGET TABLE: BSL_MA.DWH_MA.DIM_PRODUCT
SOURCE TABLES: BSL_RAW.DWH_RAW.PRODUCTS
DESCRIPTION: Product dimension table that transforms raw product data with price banding and data quality enhancements
PREREQUISITES: Source table BSL_RAW.DWH_RAW.PRODUCTS must exist with required columns
PARAMETER: None
AUTHOR: AI Generated by Shajahan - 2024-12-19
------------------------------------------------------------------------
#}

with source_data as (
    select
        product_id,
        product_name,
        price
    from {{ source('dwh_raw', 'products') }}
),

transformed_data as (
    select
        -- Direct mapping for product_id
        product_id,
        
        -- Title-case product name with trimmed spaces
        initcap(trim(regexp_replace(product_name, '\\s+', ' '))) as product_name,
        
        -- Direct mapping for price with precision
        cast(price as number(10,2)) as price,
        
        -- Price banding logic
        case
            when price < 50 then 'Low'
            when price >= 50 and price <= 199.99 then 'Mid'
            when price >= 200 and price <= 499.99 then 'High'
            when price >= 500 then 'Premium'
            else 'Unknown'
        end as price_band,
        
        -- Flag for review when price is 0
        case
            when price = 0 then 'Price is zero - requires review'
            else null
        end as review_notes
        
    from source_data
)

select * from transformed_data