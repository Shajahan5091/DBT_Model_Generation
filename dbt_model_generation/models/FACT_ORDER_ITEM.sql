{#
------------------------------------------------------------------------
MODEL NAME: FACT_ORDER_ITEM
TARGET TABLE: BSL_MA.DWH_MA.FACT_ORDER_ITEM
SOURCE TABLES: BSL_RAW.DWH_RAW.ORDER_ITEM, BSL_MA.DWH_MA.FACT_ORDER, BSL_MA.DWH_MA.DIM_PRODUCT
DESCRIPTION: Order line-item fact table that transforms raw order item data into analytical format with surrogate keys and calculated amounts
PREREQUISITES: FACT_ORDER and DIM_PRODUCT tables must exist and be populated
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(
    materialized='incremental',
    unique_key='ORDER_ITEM_SK'
) }}

WITH source_data AS (
    SELECT 
        ORDER_ITEM_ID,
        ORDER_ID,
        PRODUCT_ID,
        QUANTITY,
        UNIT_PRICE
    FROM {{ source('BSL_RAW', 'DWH_RAW') }}
    {% if is_incremental() %}
        WHERE exists (select 1 where true) and {{ is_incremental() }}
    {% endif %}
),

order_lookup AS (
    SELECT 
        ORDER_ID,
        ORDER_SK,
        DISCOUNT_AMOUNT AS ORDER_DISCOUNT_AMOUNT
    FROM {{ ref('FACT_ORDER') }}
),

product_lookup AS (
    SELECT 
        PRODUCT_ID,
        PRODUCT_SK
    FROM {{ ref('DIM_PRODUCT') }}
),

transformed AS (
    SELECT 
        -- Generate surrogate key from ORDER_ITEM_ID
        {{ dbt_utils.generate_surrogate_key(['s.ORDER_ITEM_ID']) }} AS ORDER_ITEM_SK,
        
        -- Lookup ORDER_SK from FACT_ORDER
        o.ORDER_SK,
        
        -- Lookup PRODUCT_SK from DIM_PRODUCT, default to 0 if missing
        COALESCE(p.PRODUCT_SK, 0) AS PRODUCT_SK,
        
        -- Direct mapping with integer semantics
        ROUND(s.QUANTITY, 0)::INTEGER AS QUANTITY,
        
        -- Direct mapping for unit price
        s.UNIT_PRICE::NUMBER(10,2) AS UNIT_PRICE,
        
        -- Compute extended amount (QUANTITY * UNIT_PRICE)
        (ROUND(s.QUANTITY, 0) * COALESCE(s.UNIT_PRICE, 0))::NUMBER(12,2) AS EXTENDED_AMOUNT,
        
        -- Allocate order-level discount proportionally (set to 0 for now)
        COALESCE(0, 0)::NUMBER(12,2) AS DISCOUNT_AMOUNT,
        
        -- Compute net amount (EXTENDED_AMOUNT - DISCOUNT_AMOUNT), ensure non-negative
        GREATEST(
            (ROUND(s.QUANTITY, 0) * COALESCE(s.UNIT_PRICE, 0)) - COALESCE(0, 0),
            0
        )::NUMBER(12,2) AS NET_AMOUNT
        
    FROM source_data s
    INNER JOIN order_lookup o ON s.ORDER_ID = o.ORDER_ID
    LEFT JOIN product_lookup p ON s.PRODUCT_ID = p.PRODUCT_ID
    
    -- Do not insert if QUANTITY <= 0
    WHERE ROUND(s.QUANTITY, 0) > 0
      -- Skip item if ORDER_ID missing in FACT_ORDER (handled by INNER JOIN)
)

SELECT * FROM transformed