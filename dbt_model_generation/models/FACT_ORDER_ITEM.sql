{#
------------------------------------------------------------------------
MODEL NAME: FACT_ORDER_ITEM
TARGET TABLE: BSL_MA.DWH_MA.FACT_ORDER_ITEM
SOURCE TABLES: BSL_RAW.DWH_RAW.ORDER_ITEM_ID, BSL_MA.DWH_MA.FACT_ORDER, BSL_MA.DWH_MA.DIM_PRODUCT
DESCRIPTION: Order line-item fact table that processes order items with quantity validation, product lookups, and calculated amounts including extended and net amounts with discount allocation.
PREREQUISITES: FACT_ORDER and DIM_PRODUCT tables must exist and be populated
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(
    materialized='incremental',
    unique_key='ORDER_ITEM_SK'
) }}

with source_data as (
    select *
    from {{ source('dwh_raw', 'order_item_id') }}
    {% if is_incremental() %}
    where exists (select 1 where true) and {{ is_incremental() }}
    {% endif %}
),

fact_order as (
    select 
        ORDER_ID,
        ORDER_SK
    from {{ ref('FACT_ORDER') }}
),

dim_product as (
    select 
        PRODUCT_ID,
        PRODUCT_SK
    from {{ ref('DIM_PRODUCT') }}
),

transformed as (
    select
        -- Generate surrogate key from ORDER_ITEM_ID
        {{ dbt_utils.generate_surrogate_key(['s.ORDER_ITEM_ID']) }} as ORDER_ITEM_SK,
        
        -- Lookup ORDER_SK from FACT_ORDER
        coalesce(fo.ORDER_SK, 0) as ORDER_SK,
        
        -- Lookup PRODUCT_SK from DIM_PRODUCT, set to 0 if missing (unknown)
        coalesce(dp.PRODUCT_SK, 0) as PRODUCT_SK,
        
        -- Direct mapping with integer semantics
        round(s.QUANTITY, 0)::INTEGER as QUANTITY,
        
        -- Direct mapping for unit price
        s.UNIT_PRICE::NUMBER(10,2) as UNIT_PRICE,
        
        -- Compute extended amount (QUANTITY * UNIT_PRICE)
        (round(s.QUANTITY, 0) * coalesce(s.UNIT_PRICE, 0))::NUMBER(12,2) as EXTENDED_AMOUNT,
        
        -- Set discount amount to 0 for now (can be enhanced with order-level discount logic)
        0::NUMBER(12,2) as DISCOUNT_AMOUNT,
        
        -- Compute net amount (EXTENDED_AMOUNT - DISCOUNT_AMOUNT), ensure non-negative
        greatest(
            (round(s.QUANTITY, 0) * coalesce(s.UNIT_PRICE, 0)) - 0, 
            0
        )::NUMBER(12,2) as NET_AMOUNT
        
    from source_data s
    left join fact_order fo on s.ORDER_ID = fo.ORDER_ID
    left join dim_product dp on s.PRODUCT_ID = dp.PRODUCT_ID
    
    where 1=1
        -- Do not insert if QUANTITY <= 0
        and s.QUANTITY > 0
        -- Skip item if ORDER_ID missing in FACT_ORDER
        and fo.ORDER_SK is not null
)

select * from transformed