{#
------------------------------------------------------------------------
MODEL NAME: fact_order_item
TARGET TABLE: BSL_MA.DWH_MA.FACT_ORDER_ITEM
SOURCE TABLES: BSL_RAW.DWH_RAW.ORDER_ITEMS, BSL_MA.DWH_MA.FACT_ORDER, BSL_MA.DWH_MA.DIM_PRODUCT
DESCRIPTION: Order line-item fact table that transforms raw order item data into a dimensional model with surrogate keys and calculated amounts
PREREQUISITES: fact_order and dim_product tables must exist and be populated
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(
    materialized='incremental',
    unique_key='order_item_sk'
) }}

with source_data as (
    select *
    from {{ source('dwh_raw', 'order_items') }}
    {% if is_incremental() %}
    where exists (select 1 where true) and {{ is_incremental() }}
    {% endif %}
),

-- Filter out invalid records
filtered_data as (
    select *
    from source_data
    where quantity > 0  -- Do not insert if quantity <= 0
),

-- Join with fact_order to get order_sk
order_lookup as (
    select 
        fd.*,
        fo.order_sk
    from filtered_data fd
    inner join {{ ref('fact_order') }} fo
        on fd.order_id = fo.order_id  -- Skip item if order_id missing in fact_order
),

-- Join with dim_product to get product_sk
product_lookup as (
    select 
        ol.*,
        coalesce(dp.product_sk, 0) as product_sk  -- If product missing set product_sk to 0 (unknown)
    from order_lookup ol
    left join {{ ref('dim_product') }} dp
        on ol.product_id = dp.product_id
),

-- Calculate final metrics
final as (
    select
        -- Generate surrogate key from order_item_id
        {{ dbt_utils.generate_surrogate_key(['order_item_id']) }} as order_item_sk,
        
        -- Lookup keys
        order_sk,
        product_sk,
        
        -- Direct mappings with transformations
        round(quantity) as quantity,  -- Ensure integer semantics; round if fractional
        unit_price,
        
        -- Calculated fields
        round(quantity) * coalesce(unit_price, 0) as extended_amount,  -- If unit_price null treat as 0
        0.00 as discount_amount,  -- Set 0 if no discount context
        greatest(0, round(quantity) * coalesce(unit_price, 0) - 0.00) as net_amount  -- Ensure non-negative; floor at 0
        
    from product_lookup
)

select * from final