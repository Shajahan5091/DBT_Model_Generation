{#
------------------------------------------------------------------------
MODEL NAME: FACT_INVENTORY
TARGET TABLE: BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES: BSL_RAW.DWH_RAW.FACT_INVENTORY, BSL_RAW.DWH_RAW.DIM_PRODUCT, BSL_RAW.DWH_RAW.DIM_SUPPLIER
DESCRIPTION: Inventory latest snapshot fact table that transforms raw inventory data with product and supplier lookups, handles missing references, and flags latest records per composite key
PREREQUISITES: DIM_PRODUCT and DIM_SUPPLIER tables must exist in source
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

WITH inventory_base AS (
    SELECT 
        PRODUCT_ID,
        SUPPLIER_ID,
        STOCK_QTY,
        WAREHOUSE_LOCATION,
        LAST_UPDATED
    FROM {{ source('dwh_raw', 'FACT_INVENTORY') }}
),

product_lookup AS (
    SELECT 
        PRODUCT_ID,
        PRODUCT_SK
    FROM {{ source('dwh_raw', 'DIM_PRODUCT') }}
),

supplier_lookup AS (
    SELECT 
        SUPPLIER_ID,
        SUPPLIER_SK
    FROM {{ source('dwh_raw', 'DIM_SUPPLIER') }}
),

inventory_with_keys AS (
    SELECT 
        i.PRODUCT_ID,
        i.SUPPLIER_ID,
        -- Lookup PRODUCT_SK with fallback to 0 for unknown
        COALESCE(p.PRODUCT_SK, 0) AS PRODUCT_SK,
        -- Lookup SUPPLIER_SK with fallback to 0 for unknown
        COALESCE(s.SUPPLIER_SK, 0) AS SUPPLIER_SK,
        -- Handle negative stock quantities by setting to null
        CASE 
            WHEN i.STOCK_QTY < 0 THEN NULL 
            ELSE i.STOCK_QTY 
        END AS STOCK_QTY,
        -- Uppercase warehouse location
        UPPER(i.WAREHOUSE_LOCATION) AS WAREHOUSE_LOCATION,
        -- Convert timestamp to date
        DATE(i.LAST_UPDATED) AS SNAPSHOT_DATE,
        i.LAST_UPDATED
    FROM inventory_base i
    LEFT JOIN product_lookup p ON i.PRODUCT_ID = p.PRODUCT_ID
    LEFT JOIN supplier_lookup s ON i.SUPPLIER_ID = s.SUPPLIER_ID
),

inventory_with_latest_flag AS (
    SELECT 
        PRODUCT_SK,
        SUPPLIER_SK,
        STOCK_QTY,
        WAREHOUSE_LOCATION,
        SNAPSHOT_DATE,
        -- Flag latest record per PRODUCT_ID+SUPPLIER_ID composite key
        CASE 
            WHEN LAST_UPDATED = MAX(LAST_UPDATED) OVER (
                PARTITION BY PRODUCT_ID, SUPPLIER_ID
            ) THEN TRUE 
            ELSE FALSE 
        END AS IS_LATEST
    FROM inventory_with_keys
)

SELECT 
    PRODUCT_SK,
    SUPPLIER_SK,
    STOCK_QTY,
    WAREHOUSE_LOCATION,
    SNAPSHOT_DATE,
    IS_LATEST
FROM inventory_with_latest_flag