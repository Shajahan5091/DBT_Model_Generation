{#
------------------------------------------------------------------------
MODEL NAME: FACT_INVENTORY
TARGET TABLE: BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES: BSL_RAW.DWH_RAW.FACT_INVENTORY, BSL_MA.DWH_MA.DIM_PRODUCT, BSL_MA.DWH_MA.DIM_SUPPLIER
DESCRIPTION: Inventory latest snapshot fact table with product and supplier dimension lookups
PREREQUISITES: DIM_PRODUCT and DIM_SUPPLIER tables must exist and be populated
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

WITH source_data AS (
    SELECT 
        PRODUCT_ID,
        SUPPLIER_ID,
        STOCK_QTY,
        WAREHOUSE_LOCATION,
        LAST_UPDATED
    FROM {{ source('dwh_raw', 'fact_inventory') }}
),

product_lookup AS (
    SELECT 
        PRODUCT_ID,
        PRODUCT_SK
    FROM {{ ref('dim_product') }}
),

supplier_lookup AS (
    SELECT 
        SUPPLIER_ID,
        SUPPLIER_SK
    FROM {{ ref('dim_supplier') }}
),

latest_records AS (
    SELECT 
        PRODUCT_ID,
        SUPPLIER_ID,
        MAX(LAST_UPDATED) AS max_last_updated
    FROM source_data
    GROUP BY PRODUCT_ID, SUPPLIER_ID
),

transformed AS (
    SELECT 
        -- Product dimension lookup with unknown handling
        COALESCE(p.PRODUCT_SK, 0) AS PRODUCT_SK,
        
        -- Supplier dimension lookup with unknown handling  
        COALESCE(s.SUPPLIER_SK, 0) AS SUPPLIER_SK,
        
        -- Stock quantity with negative value handling
        CASE 
            WHEN s_data.STOCK_QTY < 0 THEN NULL
            ELSE s_data.STOCK_QTY
        END AS STOCK_QTY,
        
        -- Warehouse location uppercase transformation
        UPPER(s_data.WAREHOUSE_LOCATION) AS WAREHOUSE_LOCATION,
        
        -- Convert timestamp to date
        s_data.LAST_UPDATED::DATE AS SNAPSHOT_DATE,
        
        -- Flag for latest record per composite key
        CASE 
            WHEN s_data.LAST_UPDATED = lr.max_last_updated THEN TRUE
            ELSE FALSE
        END AS IS_LATEST,
        
        -- Retain original fields for audit purposes
        s_data.PRODUCT_ID AS ORIGINAL_PRODUCT_ID,
        s_data.SUPPLIER_ID AS ORIGINAL_SUPPLIER_ID,
        s_data.LAST_UPDATED AS ORIGINAL_LAST_UPDATED
        
    FROM source_data s_data
    LEFT JOIN product_lookup p 
        ON s_data.PRODUCT_ID = p.PRODUCT_ID
    LEFT JOIN supplier_lookup s 
        ON s_data.SUPPLIER_ID = s.SUPPLIER_ID
    LEFT JOIN latest_records lr 
        ON s_data.PRODUCT_ID = lr.PRODUCT_ID 
        AND s_data.SUPPLIER_ID = lr.SUPPLIER_ID
)

SELECT * FROM transformed