{#
------------------------------------------------------------------------
MODEL NAME: fact_inventory
TARGET TABLE: BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES: BSL_RAW.DWH_RAW.INVENTORY
DESCRIPTION: Inventory fact table containing latest snapshot of product inventory by supplier and warehouse location with proper dimension lookups
PREREQUISITES: dim_product and dim_supplier tables must exist in the target schema
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

WITH source_data AS (
    SELECT 
        product_id,
        supplier_id,
        stock_qty,
        warehouse_location,
        last_updated
    FROM {{ source('dwh_raw', 'inventory') }}
),

-- Add row number to identify latest records per composite key
ranked_data AS (
    SELECT 
        *,
        ROW_NUMBER() OVER (
            PARTITION BY product_id, supplier_id 
            ORDER BY last_updated DESC
        ) = 1 AS is_latest
    FROM source_data
),

-- Lookup dimension keys and apply transformations
final AS (
    SELECT 
        -- Product dimension lookup with unknown handling
        COALESCE(dp.product_sk, 0) AS product_sk,
        
        -- Supplier dimension lookup with unknown handling  
        COALESCE(ds.supplier_sk, 0) AS supplier_sk,
        
        -- Stock quantity with negative value handling
        CASE 
            WHEN stock_qty < 0 THEN NULL 
            ELSE stock_qty 
        END AS stock_qty,
        
        -- Warehouse location uppercase transformation
        UPPER(warehouse_location) AS warehouse_location,
        
        -- Convert timestamp to date
        last_updated::DATE AS snapshot_date,
        
        -- Latest record flag
        is_latest,
        
        -- Audit fields for missing lookups
        CASE WHEN dp.product_sk IS NULL THEN product_id END AS missing_product_id,
        CASE WHEN ds.supplier_sk IS NULL THEN supplier_id END AS missing_supplier_id,
        CASE WHEN stock_qty < 0 THEN TRUE ELSE FALSE END AS negative_stock_flag
        
    FROM ranked_data rd
    LEFT JOIN {{ ref('dim_product') }} dp 
        ON rd.product_id = dp.product_id
    LEFT JOIN {{ ref('dim_supplier') }} ds 
        ON rd.supplier_id = ds.supplier_id
)

SELECT * FROM final