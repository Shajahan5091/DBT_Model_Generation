{#
------------------------------------------------------------------------
MODEL NAME: fact_inventory
TARGET TABLE: BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES: BSL_RAW.DWH_RAW.INVENTORY
DESCRIPTION: Inventory latest snapshot model that transforms raw inventory data with product and supplier lookups, data quality checks, and latest record flagging
PREREQUISITES: dim_product and dim_supplier tables must exist for lookup operations
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

with source_data as (
    select 
        product_id,
        supplier_id,
        stock_qty,
        warehouse_location,
        last_updated
    from {{ source('dwh_raw', 'inventory') }}
),

-- Window function to identify latest records per product_id + supplier_id
latest_flags as (
    select 
        *,
        case 
            when last_updated = max(last_updated) over (partition by product_id, supplier_id) 
            then true 
            else false 
        end as is_latest_record
    from source_data
),

-- Product lookup with fallback to unknown
product_lookup as (
    select 
        s.*,
        coalesce(p.product_id, 0) as mapped_product_id
    from latest_flags s
    left join {{ ref('dim_product') }} p 
        on s.product_id = p.product_id
),

-- Supplier lookup with fallback to unknown  
supplier_lookup as (
    select 
        s.*,
        coalesce(sup.supplier_id, 0) as mapped_supplier_id
    from product_lookup s
    left join {{ ref('dim_supplier') }} sup 
        on s.supplier_id = sup.supplier_id
),

-- Final transformations
final as (
    select 
        mapped_product_id as product_id,
        mapped_supplier_id as supplier_id,
        case 
            when stock_qty < 0 then null 
            else stock_qty 
        end as stock_qty,
        upper(warehouse_location) as warehouse_location,
        last_updated::date as snapshot_date,
        is_latest_record as is_latest
    from supplier_lookup
)

select * from final