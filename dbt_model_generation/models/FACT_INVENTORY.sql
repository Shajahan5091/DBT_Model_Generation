{#
------------------------------------------------------------------------
MODEL NAME: fact_inventory
TARGET TABLE: BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES: BSL_RAW.DWH_RAW.INVENTORY
DESCRIPTION: Inventory latest snapshot model that transforms raw inventory data with product and supplier lookups, data quality checks, and latest record flagging
PREREQUISITES: dim_product and dim_supplier models must exist
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

WITH source_data AS (
    SELECT 
        product_id,
        supplier_id,
        stock_qty,
        warehouse_location,
        last_updated
    FROM {{ source('dwh_raw', 'inventory') }}
),

product_lookup AS (
    SELECT 
        product_id
    FROM {{ ref('dim_product') }}
),

supplier_lookup AS (
    SELECT 
        supplier_id
    FROM {{ ref('dim_supplier') }}
),

transformed_data AS (
    SELECT 
        -- Product ID lookup with unknown handling
        COALESCE(p.product_id, 0) AS product_id,
        
        -- Supplier ID lookup with unknown handling  
        COALESCE(s.supplier_id, 0) AS supplier_id,
        
        -- Stock quantity with negative value handling
        CASE 
            WHEN s_data.stock_qty < 0 THEN NULL
            ELSE s_data.stock_qty
        END AS stock_qty,
        
        -- Warehouse location uppercase transformation
        UPPER(s_data.warehouse_location) AS warehouse_location,
        
        -- Convert timestamp to date
        s_data.last_updated::DATE AS snapshot_date,
        
        -- Flag for latest record per product_id + supplier_id
        CASE 
            WHEN s_data.last_updated = MAX(s_data.last_updated) OVER (
                PARTITION BY COALESCE(p.product_id, 0), COALESCE(s.supplier_id, 0)
            ) 
            THEN TRUE 
            ELSE FALSE 
        END AS is_latest
        
    FROM source_data s_data
    LEFT JOIN product_lookup p 
        ON s_data.product_id::INTEGER = p.product_id
    LEFT JOIN supplier_lookup s 
        ON s_data.supplier_id::INTEGER = s.supplier_id
)

SELECT 
    product_id,
    supplier_id,
    stock_qty,
    warehouse_location,
    snapshot_date,
    is_latest
FROM transformed_data