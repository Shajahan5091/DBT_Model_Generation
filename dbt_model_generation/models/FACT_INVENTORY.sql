{#
------------------------------------------------------------------------
MODEL NAME: FACT_INVENTORY
TARGET TABLE: BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES: BSL_RAW.DWH_RAW.INVENTORY
DESCRIPTION: This model transforms raw inventory data into a fact table with proper dimension lookups and data quality checks. It includes latest snapshot flagging and handles missing dimension references.
PREREQUISITES: DIM_PRODUCT and DIM_SUPPLIER dimension tables must exist
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

WITH inventory_base AS (
    SELECT 
        PRODUCT_ID,
        SUPPLIER_ID,
        STOCK_QTY,
        WAREHOUSE_LOCATION,
        LAST_UPDATED
    FROM {{ source('dwh_raw', 'inventory') }}
),

inventory_with_flags AS (
    SELECT 
        *,
        -- Flag latest record per PRODUCT_ID + SUPPLIER_ID combination
        CASE 
            WHEN LAST_UPDATED = MAX(LAST_UPDATED) OVER (PARTITION BY PRODUCT_ID, SUPPLIER_ID) 
            THEN TRUE 
            ELSE FALSE 
        END AS IS_LATEST
    FROM inventory_base
),

inventory_transformed AS (
    SELECT 
        -- Lookup PRODUCT_SK from DIM_PRODUCT, set to 0 if missing
        COALESCE(dp.PRODUCT_SK, 0) AS PRODUCT_SK,
        
        -- Lookup SUPPLIER_SK from DIM_SUPPLIER, set to 0 if missing  
        COALESCE(ds.SUPPLIER_SK, 0) AS SUPPLIER_SK,
        
        -- Handle negative stock quantities by setting to null
        CASE 
            WHEN inv.STOCK_QTY < 0 THEN NULL 
            ELSE inv.STOCK_QTY 
        END AS STOCK_QTY,
        
        -- Uppercase warehouse location
        UPPER(inv.WAREHOUSE_LOCATION) AS WAREHOUSE_LOCATION,
        
        -- Convert timestamp to date
        inv.LAST_UPDATED::DATE AS SNAPSHOT_DATE,
        
        -- Latest record flag
        inv.IS_LATEST
        
    FROM inventory_with_flags inv
    
    -- Left join to retain records even if dimension lookups fail
    LEFT JOIN {{ ref('dim_product') }} dp 
        ON inv.PRODUCT_ID = dp.PRODUCT_ID
        
    LEFT JOIN {{ ref('dim_supplier') }} ds 
        ON inv.SUPPLIER_ID = ds.SUPPLIER_ID
)

SELECT * FROM inventory_transformed