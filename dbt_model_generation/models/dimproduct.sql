{#
------------------------------------------------------------------------
MODEL NAME: DimProduct
TARGET TABLE: BSL_FINAL.DWH_MA.DIMPRODUCT
SOURCE TABLES: BSL_STAGING.DWH_STAGING.PRODUCT, BSL_STAGING.DWH_STAGING.PRODUCT_CATEGORY, BSL_STAGING.DWH_STAGING.PRODUCT_DISCOUNT, BSL_STAGING.DWH_STAGING.INVENTORY
DESCRIPTION: Stores product master details including product name, brand, category, and pricing attributes with calculated discounted prices and active status based on inventory.
PREREQUISITES: Source tables must be available in staging layer with proper data quality checks
PARAMETER: None
AUTHOR: AI Generated by Shajahan - 2024-12-19 (IST)
------------------------------------------------------------------------
#}

WITH product_base AS (
    SELECT 
        product_id,
        product_name,
        brand,
        product_category_id
    FROM {{ source('dwh_staging', 'product') }}
),

product_category AS (
    SELECT 
        product_category_id,
        category_name
    FROM {{ source('dwh_staging', 'product_category') }}
),

product_discount AS (
    SELECT 
        product_id,
        discount_pct,
        base_price,
        effective_from,
        effective_to
    FROM {{ source('dwh_staging', 'product_discount') }}
    WHERE CURRENT_DATE() BETWEEN effective_from AND effective_to
),

inventory_status AS (
    SELECT 
        product_id,
        quantity_on_hand,
        CASE 
            WHEN quantity_on_hand > 0 THEN TRUE 
            ELSE FALSE 
        END AS active_flag
    FROM {{ source('dwh_staging', 'inventory') }}
),

final AS (
    SELECT 
        pb.product_id,
        pb.product_name,
        pb.brand,
        pc.category_name,
        CASE 
            WHEN pd.discount_pct IS NOT NULL AND pd.base_price IS NOT NULL 
            THEN pd.base_price * (1 - pd.discount_pct / 100)
            ELSE pd.base_price
        END AS current_unit_price,
        COALESCE(inv.active_flag, FALSE) AS active_flag
    FROM product_base pb
    LEFT JOIN product_category pc 
        ON pb.product_category_id = pc.product_category_id
    LEFT JOIN product_discount pd 
        ON pb.product_id = pd.product_id
    LEFT JOIN inventory_status inv 
        ON pb.product_id = inv.product_id
)

SELECT * FROM final