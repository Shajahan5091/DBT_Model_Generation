{#
------------------------------------------------------------------------
MODEL NAME: DimProduct
TARGET TABLE: BSL_FINAL.DWH_MA.DIMPRODUCT
SOURCE TABLES: BSL_STAGING.DWH_STAGING.PRODUCT, BSL_STAGING.DWH_STAGING.PRODUCT_CATEGORY, BSL_STAGING.DWH_STAGING.PRODUCT_DISCOUNT, BSL_STAGING.DWH_STAGING.INVENTORY
DESCRIPTION: Dimension table that stores product master details including product name, brand, category, and pricing attributes with current unit price calculated based on discounts and active flag determined by inventory levels.
PREREQUISITES: Source tables Product, Product_Category, Product_Discount, and Inventory must be available in staging layer
PARAMETER: None
AUTHOR: AI Generated by Shajahan - 2024-12-19 (IST)
------------------------------------------------------------------------
#}

WITH product_base AS (
    SELECT 
        product_id,
        product_name,
        brand,
        product_category_id
    FROM {{ source('dwh_staging', 'product') }}
),

product_category_lookup AS (
    SELECT 
        product_category_id,
        category_name
    FROM {{ source('dwh_staging', 'product_category') }}
),

product_discount_lookup AS (
    SELECT 
        product_id,
        discount_pct,
        effective_from,
        effective_to
    FROM {{ source('dwh_staging', 'product_discount') }}
    WHERE CURRENT_DATE() BETWEEN effective_from AND effective_to
),

inventory_lookup AS (
    SELECT 
        product_id,
        quantity_on_hand
    FROM {{ source('dwh_staging', 'inventory') }}
),

final AS (
    SELECT 
        p.product_id,
        p.product_name,
        p.brand,
        pc.category_name,
        CASE 
            WHEN pd.discount_pct IS NOT NULL 
            THEN p.unit_price * (1 - pd.discount_pct / 100)
            ELSE p.unit_price
        END AS current_unit_price,
        CASE 
            WHEN COALESCE(inv.quantity_on_hand, 0) > 0 
            THEN TRUE 
            ELSE FALSE 
        END AS active_flag
    FROM product_base p
    LEFT JOIN product_category_lookup pc 
        ON p.product_category_id = pc.product_category_id
    LEFT JOIN product_discount_lookup pd 
        ON p.product_id = pd.product_id
    LEFT JOIN inventory_lookup inv 
        ON p.product_id = inv.product_id
)

SELECT * FROM final