{#
------------------------------------------------------------------------
MODEL NAME: DIM_CUSTOMER
TARGET TABLE: BSL_MA.DWH_MA.DIM_CUSTOMER
SOURCE TABLES: BSL_RAW.DWH_RAW.CUSTOMER, BSL_MA.DWH_MA.FACT_ORDER
DESCRIPTION: Customer master dimension table that consolidates customer information with derived attributes including customer tier based on spending patterns
PREREQUISITES: FACT_ORDER table must exist for customer tier calculation
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(
    materialized='table',
    unique_key='CUSTOMER_SK'
) }}

WITH customer_raw AS (
    SELECT 
        CUSTOMER_ID,
        FIRST_NAME,
        LAST_NAME,
        EMAIL,
        INSERTED_AT
    FROM {{ source('BSL_RAW', 'CUSTOMER') }}
    WHERE CUSTOMER_ID IS NOT NULL 
      AND TRIM(CUSTOMER_ID) != ''
      AND CUSTOMER_ID != 'NULL'
),

-- Calculate customer spending in last 365 days for tier determination
customer_spending AS (
    SELECT 
        c.CUSTOMER_ID,
        COALESCE(SUM(f.ORDER_AMOUNT), 0) AS total_spending_365_days
    FROM customer_raw c
    LEFT JOIN {{ ref('FACT_ORDER') }} f 
        ON c.CUSTOMER_ID = f.CUSTOMER_ID
        AND f.ORDER_DATE >= DATEADD('day', -365, CURRENT_DATE())
    GROUP BY c.CUSTOMER_ID
),

-- Determine customer tier based on spending
customer_tier AS (
    SELECT 
        CUSTOMER_ID,
        total_spending_365_days,
        CASE 
            WHEN total_spending_365_days >= 1000 THEN 'Gold'
            WHEN total_spending_365_days >= 500 THEN 'Silver'
            ELSE 'Bronze'
        END AS CUSTOMER_TIER
    FROM customer_spending
),

-- Email validation function
email_validated AS (
    SELECT 
        *,
        CASE 
            WHEN EMAIL IS NOT NULL 
                 AND REGEXP_LIKE(EMAIL, '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$')
            THEN LOWER(TRIM(EMAIL))
            ELSE NULL
        END AS validated_email,
        CASE 
            WHEN EMAIL IS NOT NULL 
                 AND NOT REGEXP_LIKE(EMAIL, '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$')
            THEN 'Invalid email format'
            ELSE NULL
        END AS data_quality_issue
    FROM customer_raw
)

SELECT 
    -- Generate surrogate key from CUSTOMER_ID
    {{ dbt_utils.generate_surrogate_key(['c.CUSTOMER_ID']) }} AS CUSTOMER_SK,
    
    -- Direct mapping of CUSTOMER_ID
    c.CUSTOMER_ID,
    
    -- Trim and proper-case first name, handle non-ASCII characters
    INITCAP(TRIM(c.FIRST_NAME)) AS FIRST_NAME,
    
    -- Trim and proper-case last name
    INITCAP(TRIM(c.LAST_NAME)) AS LAST_NAME,
    
    -- Validated and lowercase email
    ev.validated_email AS EMAIL,
    
    -- Convert timestamp to date, default to current_date if null
    COALESCE(DATE(c.INSERTED_AT), CURRENT_DATE()) AS CUSTOMER_SINCE_DATE,
    
    -- Derived customer tier based on spending
    ct.CUSTOMER_TIER,
    
    -- Data quality tracking
    ev.data_quality_issue,
    
    -- Audit fields
    CURRENT_TIMESTAMP() AS dbt_updated_at,
    CURRENT_USER() AS dbt_updated_by

FROM customer_raw c
LEFT JOIN customer_tier ct ON c.CUSTOMER_ID = ct.CUSTOMER_ID
LEFT JOIN email_validated ev ON c.CUSTOMER_ID = ev.CUSTOMER_ID