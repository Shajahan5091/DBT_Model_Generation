{#
------------------------------------------------------------------------
MODEL NAME: dim_customer
TARGET TABLE: BSL_MA.DWH_MA.DIM_CUSTOMER
SOURCE TABLES: BSL_RAW.DWH_RAW.CUSTOMERS, BSL_RAW.DWH_RAW.ORDERS
DESCRIPTION: Customer dimension table that transforms raw customer data with proper formatting, email validation, tier calculation based on order history, and data quality checks
PREREQUISITES: Source tables customers and orders must be available in dwh_raw schema
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

with source_customers as (
    select 
        customer_id,
        first_name,
        last_name,
        email,
        inserted_at
    from {{ source('dwh_raw', 'customers') }}
),

source_orders as (
    select 
        customer_id,
        order_id,
        order_amount,
        order_date
    from {{ source('dwh_raw', 'orders') }}
    where order_date >= current_date - 365
),

customer_order_totals as (
    select 
        customer_id,
        sum(order_amount) as total_order_amount_365d
    from source_orders
    group by customer_id
),

transformed_customers as (
    select 
        -- Direct mapping
        c.customer_id,
        
        -- Trim and uppercase first name
        upper(trim(c.first_name)) as first_name,
        
        -- Trim and uppercase last name  
        upper(trim(c.last_name)) as last_name,
        
        -- Lowercase email with basic pattern validation
        case 
            when c.email is not null 
                and c.email like '%@%.%' 
                and length(c.email) > 5
            then lower(trim(c.email))
            else null
        end as email,
        
        -- Convert timestamp to date with default handling
        coalesce(c.inserted_at::date, current_date) as customer_since_date,
        
        -- Derive customer tier based on order amounts
        case 
            when coalesce(cot.total_order_amount_365d, 0) >= 1000 then 'Gold'
            when coalesce(cot.total_order_amount_365d, 0) >= 500 then 'Silver'
            else 'Bronze'
        end as customer_tier,
        
        -- Data quality flag for email issues
        case 
            when c.email is not null 
                and (c.email not like '%@%.%' or length(c.email) <= 5)
            then 'Email failed pattern validation'
            else null
        end as data_quality_issue
        
    from source_customers c
    left join customer_order_totals cot
        on c.customer_id = cot.customer_id
)

select * from transformed_customers