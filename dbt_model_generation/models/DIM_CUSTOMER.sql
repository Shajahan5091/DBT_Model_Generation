{#
------------------------------------------------------------------------
MODEL NAME: DIM_CUSTOMER
TARGET TABLE: BSL_MA.DWH_MA.DIM_CUSTOMER
SOURCE TABLES: BSL_RAW.DWH_RAW.CUSTOMERS
DESCRIPTION: Customer master dimension table that transforms raw customer data with data quality checks, generates surrogate keys, and derives customer spending tiers based on order history
PREREQUISITES: Source table BSL_RAW.DWH_RAW.CUSTOMERS must be available
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(materialized='view') }}

with customer_base as (
    select 
        customer_id,
        first_name,
        last_name,
        email,
        inserted_at
    from {{ source('dwh_raw', 'customers') }}
    where customer_id is not null 
    and trim(customer_id) != ''
),

customer_orders as (
    select 
        c.customer_id,
        coalesce(sum(f.order_amount), 0) as total_order_amount_365d
    from customer_base c
    left join {{ source('dwh_raw', 'fact_order') }} f
        on c.customer_id = f.customer_id
        and f.order_date >= current_date - 365
    group by c.customer_id
),

final as (
    select
        -- Generate surrogate key from CUSTOMER_ID
        {{ dbt_utils.generate_surrogate_key(['cb.customer_id']) }} as customer_sk,
        
        -- Direct mapping of customer_id
        cb.customer_id,
        
        -- Trim and upper-case first name
        upper(trim(cb.first_name)) as first_name,
        
        -- Trim and upper-case last name  
        upper(trim(cb.last_name)) as last_name,
        
        -- Lowercase email with basic pattern validation
        case 
            when cb.email is not null 
            and cb.email like '%@%.%' 
            and length(trim(cb.email)) > 5
            then lower(trim(cb.email))
            else null
        end as email,
        
        -- Convert timestamp to date, default to current_date if null
        coalesce(cb.inserted_at::date, current_date) as customer_since_date,
        
        -- Derive customer tier based on total order amount in last 365 days
        case 
            when co.total_order_amount_365d >= 1000 then 'GOLD'
            when co.total_order_amount_365d >= 500 then 'SILVER'
            else 'BRONZE'
        end as customer_tier
        
    from customer_base cb
    left join customer_orders co
        on cb.customer_id = co.customer_id
)

select * from final