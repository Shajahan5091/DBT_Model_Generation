{#
------------------------------------------------------------------------
MODEL NAME: dim_customer
TARGET TABLE: bsl_ma.dwh_ma.dim_customer
SOURCE TABLES: bsl_raw.dwh_raw.customers, bsl_raw.dwh_raw.fact_order
DESCRIPTION: Customer dimension table that consolidates customer information with derived spending tiers based on order history
PREREQUISITES: Source tables bsl_raw.dwh_raw.customers and bsl_raw.dwh_raw.fact_order must be available
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

with customer_base as (
    select 
        customer_id,
        trim(upper(first_name)) as first_name,
        trim(upper(last_name)) as last_name,
        case 
            when email is null or email = '' or not regexp_like(email, '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$')
            then null
            else lower(trim(email))
        end as email,
        case 
            when inserted_at is null 
            then current_date()
            else date(inserted_at)
        end as customer_since_date
    from {{ source('dwh_raw', 'customers') }}
),

customer_orders as (
    select 
        customer_id,
        sum(order_amount) as total_order_amount_365d
    from {{ source('dwh_raw', 'fact_order') }}
    where order_date >= dateadd('day', -365, current_date())
    group by customer_id
),

final as (
    select 
        cb.customer_id,
        cb.first_name,
        cb.last_name,
        cb.email,
        cb.customer_since_date,
        case 
            when coalesce(co.total_order_amount_365d, 0) >= 1000 then 'Gold'
            when coalesce(co.total_order_amount_365d, 0) >= 500 then 'Silver'
            else 'Bronze'
        end as customer_tier
    from customer_base cb
    left join customer_orders co 
        on cb.customer_id = co.customer_id
)

select * from final