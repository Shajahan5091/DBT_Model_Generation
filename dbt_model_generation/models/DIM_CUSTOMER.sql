{#
------------------------------------------------------------------------
MODEL NAME: DIM_CUSTOMER
TARGET TABLE: BSL_MA.DWH_MA.DIM_CUSTOMER
SOURCE TABLES: BSL_RAW.DWH_RAW.CUSTOMERS, BSL_RAW.DWH_RAW.ORDERS
DESCRIPTION: Customer master dimension table that consolidates customer information with derived spending tiers based on order history
PREREQUISITES: Source tables CUSTOMERS and ORDERS must be available in BSL_RAW.DWH_RAW schema
PARAMETER: None
AUTHOR: AI Generated by Shajahan - 2024-12-19 IST
------------------------------------------------------------------------
#}

{{ config(
    materialized='view'
) }}

with customer_base as (
    select
        customer_id,
        first_name,
        last_name,
        email,
        inserted_at
    from {{ source('dwh_raw', 'customers') }}
    where customer_id is not null 
    and trim(customer_id) != ''
),

customer_orders as (
    select
        customer_id,
        sum(order_amount) as total_order_amount
    from {{ source('dwh_raw', 'orders') }}
    where order_date >= current_date - 365
    group by customer_id
),

customer_tier_logic as (
    select
        cb.customer_id,
        cb.first_name,
        cb.last_name,
        cb.email,
        cb.inserted_at,
        coalesce(co.total_order_amount, 0) as total_order_amount,
        case
            when coalesce(co.total_order_amount, 0) >= 1000 then 'Gold'
            when coalesce(co.total_order_amount, 0) >= 500 then 'Silver'
            else 'Bronze'
        end as customer_tier
    from customer_base cb
    left join customer_orders co on cb.customer_id = co.customer_id
)

select
    -- Generate surrogate key from CUSTOMER_ID
    {{ dbt_utils.generate_surrogate_key(['customer_id']) }} as customer_sk,
    
    -- Direct mapping of customer_id
    customer_id,
    
    -- Trim and upper-case first name, strip leading/trailing spaces
    upper(trim(first_name)) as first_name,
    
    -- Trim and upper-case last name
    upper(trim(last_name)) as last_name,
    
    -- Lowercase email for consistency, validate basic pattern
    case
        when email is not null and email like '%@%.%' then lower(trim(email))
        else null
    end as email,
    
    -- Convert timestamp to date, default to current_date if null
    coalesce(inserted_at::date, current_date) as customer_since_date,
    
    -- Derive spending tier based on total order amount in last 365 days
    customer_tier

from customer_tier_logic