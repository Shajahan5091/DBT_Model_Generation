{#
------------------------------------------------------------------------
MODEL NAME: DIM_ADDRESS
TARGET TABLE: BSL_MA.DWH_MA.DIM_ADDRESS
SOURCE TABLES: BSL_RAW.DWH_RAW.ADDRESS, BSL_MA.DWH_MA.DIM_CUSTOMER
DESCRIPTION: Customer address dimension table that transforms raw address data into a dimensional model with surrogate keys and standardized formatting
PREREQUISITES: DIM_CUSTOMER table must exist for customer lookup
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(
    materialized='table'
) }}

WITH raw_address AS (
    SELECT 
        ADDRESS_ID,
        CUSTOMER_ID,
        ADDRESS_LINE1,
        CITY,
        COUNTRY,
        INSERTED_AT
    FROM {{ source('BSL_RAW', 'ADDRESS') }}
),

customer_lookup AS (
    SELECT 
        CUSTOMER_ID,
        CUSTOMER_SK
    FROM {{ ref('DIM_CUSTOMER') }}
),

transformed_address AS (
    SELECT 
        -- Generate surrogate key from ADDRESS_ID
        {{ dbt_utils.generate_surrogate_key(['ra.ADDRESS_ID']) }} AS ADDRESS_SK,
        
        -- Direct mapping of ADDRESS_ID
        ra.ADDRESS_ID,
        
        -- Lookup CUSTOMER_SK from DIM_CUSTOMER
        cl.CUSTOMER_SK,
        
        -- Trim whitespace from ADDRESS_LINE1
        TRIM(ra.ADDRESS_LINE1) AS ADDRESS_LINE1,
        
        -- Uppercase city and normalize
        UPPER(ra.CITY) AS CITY,
        
        -- Direct mapping of COUNTRY
        ra.COUNTRY,
        
        -- Convert timestamp to date
        ra.INSERTED_AT::DATE AS CREATED_DATE
        
    FROM raw_address ra
    INNER JOIN customer_lookup cl 
        ON ra.CUSTOMER_ID = cl.CUSTOMER_ID
    WHERE cl.CUSTOMER_SK IS NOT NULL  -- Skip rows where CUSTOMER_ID not found in DIM_CUSTOMER
)

SELECT * FROM transformed_address