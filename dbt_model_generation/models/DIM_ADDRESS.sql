{#
------------------------------------------------------------------------
MODEL NAME: DIM_ADDRESS
TARGET TABLE: BSL_MA.DWH_MA.DIM_ADDRESS
SOURCE TABLES: BSL_RAW.DWH_RAW.ADDRESS
DESCRIPTION: Customer address dimension table that transforms raw address data into a dimensional model with surrogate keys and standardized formatting
PREREQUISITES: DIM_CUSTOMER table must exist for customer lookup
PARAMETER: None
AUTHOR: AI Generated by Shajahan
CREATED DATE: 2024-12-19 (IST)
------------------------------------------------------------------------
#}

{{ config(
    materialized='table'
) }}

WITH source_data AS (
    SELECT 
        ADDRESS_ID,
        CUSTOMER_ID,
        ADDRESS_LINE1,
        CITY,
        COUNTRY,
        INSERTED_AT
    FROM {{ source('dwh_raw', 'ADDRESS') }}
),

customer_lookup AS (
    SELECT 
        CUSTOMER_ID,
        CUSTOMER_SK
    FROM {{ ref('DIM_CUSTOMER') }}
),

transformed AS (
    SELECT 
        -- Generate surrogate key from ADDRESS_ID
        {{ dbt_utils.generate_surrogate_key(['s.ADDRESS_ID']) }} AS ADDRESS_SK,
        
        -- Direct mapping
        s.ADDRESS_ID,
        
        -- Lookup CUSTOMER_SK from DIM_CUSTOMER
        c.CUSTOMER_SK,
        
        -- Trim whitespace from address line
        TRIM(s.ADDRESS_LINE1) AS ADDRESS_LINE1,
        
        -- Uppercase city and normalize
        UPPER(s.CITY) AS CITY,
        
        -- Direct mapping for country
        s.COUNTRY,
        
        -- Convert timestamp to date
        s.INSERTED_AT::DATE AS CREATED_DATE
        
    FROM source_data s
    INNER JOIN customer_lookup c 
        ON s.CUSTOMER_ID = c.CUSTOMER_ID
    -- Skip rows where CUSTOMER_ID not found in DIM_CUSTOMER
    WHERE c.CUSTOMER_SK IS NOT NULL
)

SELECT * FROM transformed